{% extends "base.html" %}
{% load wagtailcore_tags static %}

{% block extra_css %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
  <link rel="stylesheet" href="{% static 'css/map.css' %}">
{% endblock %}

{% block content %}
  <section class="hero is-primary is-medium">
    <div class="hero-body">
      <div class="container">
        <h1 class="title is-1">{{ page.title }}</h1>
        {% if page.intro %}
          <div class="subtitle is-4">
            {{ page.intro|richtext }}
          </div>
        {% endif %}
      </div>
    </div>
  </section>

  <section class="section">
    <div class="container">
      <div class="columns">
        <div class="column is-8">
          <div class="box">
            <div class="level mb-4">
              <div class="level-left">
                <div class="level-item">
                  <h3 class="title is-4">Interactive Map</h3>
                </div>
              </div>
              <div class="level-right">
                <div class="level-item">
                  <div class="field has-addons">
                    <div class="control">
                      <button id="find-nearby" class="button is-primary is-outlined">
                                                <span class="icon">
                                                    <i class="fas fa-location-arrow"></i>
                                                </span>
                        <span>Find Nearby</span>
                      </button>
                    </div>
                    <div class="control">
                      <button id="fit-bounds" class="button is-info is-outlined">
                                                <span class="icon">
                                                    <i class="fas fa-expand-arrows-alt"></i>
                                                </span>
                        <span>Fit All</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div id="map" class="map-container"></div>
            <div id="map-info" class="notification is-info is-light mt-4" style="display: none;">
              <p id="map-info-text"></p>
            </div>
          </div>
        </div>

        <div class="column is-4">
          <div class="box">
            <div class="level mb-4">
              <div class="level-left">
                <div class="level-item">
                  <h3 class="title is-4">Locations</h3>
                </div>
              </div>
              <div class="level-right">
                <div class="level-item">
                  <span class="tag is-primary">{{ location_count }} total</span>
                </div>
              </div>
            </div>

            <div class="field">
              <div class="control has-icons-left">
                <input id="search-locations" class="input" type="text" placeholder="Search locations...">
                <span class="icon is-left">
                                    <i class="fas fa-search"></i>
                                </span>
              </div>
            </div>

            <div class="location-list">
              {% for location in locations %}
                <div class="location-item"
                     data-lat="{{ location.latitude }}"
                     data-lng="{{ location.longitude }}"
                     data-name="{{ location.name|lower }}">
                  <div class="level is-mobile">
                    <div class="level-left">
                      <div class="level-item">
                        <h5 class="title is-6 mb-2">{{ location.name }}</h5>
                      </div>
                    </div>
                    {% if location.distance %}
                      <div class="level-right">
                        <div class="level-item">
                                                <span class="tag is-light">
                                                    {{ location.distance.km|floatformat:1 }} km
                                                </span>
                        </div>
                      </div>
                    {% endif %}
                  </div>

                  {% if location.description %}
                    <p class="content is-small mb-2">{{ location.description }}</p>
                  {% endif %}
                  {% if location.address %}
                    <p class="content is-small has-text-grey mb-2">
                                            <span class="icon is-small">
                                                <i class="fas fa-map-marker-alt"></i>
                                            </span>
                      {{ location.address }}
                    </p>
                  {% endif %}
                  {% if location.website %}
                    <p class="content is-small">
                      <a href="{{ location.website }}"
                         target="_blank"
                         class="button is-small is-link is-outlined">
                                                <span class="icon is-small">
                                                    <i class="fas fa-external-link-alt"></i>
                                                </span>
                        <span>Visit Website</span>
                      </a>
                    </p>
                  {% endif %}
                  <hr class="my-4">
                </div>
              {% empty %}
                <p class="content">No locations found.</p>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
{% endblock %}

{% block extra_js %}
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin=""></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize map
      const map = L.map('map').setView([{{ map_center_lat }}, {{ map_center_lng }}], {{ page.zoom_level|default:6 }});

      // Add multiple tile layer options
      const tileLayers = {
        'OpenStreetMap': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }),
        'CartoDB Positron': L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
          attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> © <a href="https://carto.com/attributions">CARTO</a>'
        }),
        'OpenTopoMap': L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
          attribution: 'Map data: © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: © <a href="https://opentopomap.org">OpenTopoMap</a>'
        })
      };

      // Add default layer
      tileLayers['OpenStreetMap'].addTo(map);

      // Add layer control
      L.control.layers(tileLayers).addTo(map);

      // Custom icons
      const customIcon = L.divIcon({
        html: '<i class="fas fa-map-marker-alt has-text-danger"></i>',
        iconSize: [20, 20],
        className: 'custom-div-icon'
      });

      const userIcon = L.divIcon({
        html: '<i class="fas fa-user-circle has-text-primary"></i>',
        iconSize: [24, 24],
        className: 'custom-div-icon'
      });

      // Store all markers
      let allMarkers = [];
      let userMarker = null;

      // Load locations from GeoDjango GeoJSON API
      async function loadLocations() {
        try {
          const response = await fetch('{% url "locations:locations_geojson" %}');
          const geojsonData = await response.json();

          // Add GeoJSON layer
          const geojsonLayer = L.geoJSON(geojsonData, {
            pointToLayer: function(feature, latlng) {
              return L.marker(latlng, { icon: customIcon });
            },
            onEachFeature: function(feature, layer) {
              const props = feature.properties;
              let popupContent = `<div class="popup-content">
                                <h6 class="title is-6 mb-2">${props.name}</h6>`;

              if (props.description) {
                popupContent += `<p class="content is-small mb-2">${props.description}</p>`;
              }

              if (props.address) {
                popupContent += `<p class="content is-small has-text-grey mb-2">
                                    <span class="icon is-small">
                                        <i class="fas fa-map-marker-alt"></i>
                                    </span>
                                    ${props.address}
                                </p>`;
              }

              if (props.website) {
                popupContent += `<p class="content is-small">
                                    <a href="${props.website}" target="_blank" class="button is-small is-link is-outlined">
                                        <span class="icon is-small">
                                            <i class="fas fa-external-link-alt"></i>
                                        </span>
                                        <span>Visit</span>
                                    </a>
                                </p>`;
              }

              popupContent += `</div>`;
              layer.bindPopup(popupContent);
              allMarkers.push(layer);
            }
          }).addTo(map);

        } catch (error) {
          console.error('Error loading locations:', error);
          showMapInfo('Error loading locations', 'is-danger');
        }
      }

      // Load locations on map initialization
      loadLocations();

      // Find nearby locations using GeoDjango API
      async function findNearbyLocations(lat, lng, distance = 50) {
        try {
          const response = await fetch(
            `{% url "locations:nearby_locations" %}?lat=${lat}&lng=${lng}&distance=${distance}`
          );
          const data = await response.json();

          if (data.error) {
            showMapInfo(data.error, 'is-danger');
            return;
          }

          // Clear existing markers
          allMarkers.forEach(marker => map.removeLayer(marker));
          allMarkers = [];

          // Add user location marker
          if (userMarker) {
            map.removeLayer(userMarker);
          }
          userMarker = L.marker([lat, lng], { icon: userIcon })
            .addTo(map)
            .bindPopup('<strong>Your Location</strong>');

          // Add nearby locations
          const geojsonLayer = L.geoJSON(data, {
            pointToLayer: function(feature, latlng) {
              return L.marker(latlng, { icon: customIcon });
            },
            onEachFeature: function(feature, layer) {
              const props = feature.properties;
              let popupContent = `<div class="popup-content">
                                <h6 class="title is-6 mb-2">${props.name}</h6>`;

              if (props.distance_km) {
                popupContent += `<p class="content is-small mb-2">
                                    <span class="tag is-primary is-light">
                                        ${props.distance_km} km away
                                    </span>
                                </p>`;
              }

              if (props.description) {
                popupContent += `<p class="content is-small mb-2">${props.description}</p>`;
              }

              popupContent += `</div>`;
              layer.bindPopup(popupContent);
              allMarkers.push(layer);
            }
          }).addTo(map);

          showMapInfo(`Found ${data.features.length} locations within ${distance}km`, 'is-success');

        } catch (error) {
          console.error('Error finding nearby locations:', error);
          showMapInfo('Error finding nearby locations', 'is-danger');
        }
      }

      // Show map information
      function showMapInfo(message, type = 'is-info') {
        const infoDiv = document.getElementById('map-info');
        const infoText = document.getElementById('map-info-text');

        infoDiv.className = `notification ${type} is-light mt-4`;
        infoText.textContent = message;
        infoDiv.style.display = 'block';

        // Hide after 5 seconds
        setTimeout(() => {
          infoDiv.style.display = 'none';
        }, 5000);
      }

      // Event handlers
      document.getElementById('find-nearby').addEventListener('click', function() {
        if (navigator.geolocation) {
          showMapInfo('Getting your location...', 'is-info');
          navigator.geolocation.getCurrentPosition(
            function(position) {
              const lat = position.coords.latitude;
              const lng = position.coords.longitude;
              findNearbyLocations(lat, lng);
              map.setView([lat, lng], 10);
            },
            function(error) {
              showMapInfo('Unable to get your location', 'is-warning');
            }
          );
        } else {
          showMapInfo('Geolocation not supported', 'is-warning');
        }
      });

      document.getElementById('fit-bounds').addEventListener('click', function() {
        if (allMarkers.length > 0) {
          const group = new L.featureGroup(allMarkers);
          map.fitBounds(group.getBounds().pad(0.1));
        } else {
          loadLocations();
        }
      });

      // Search functionality
      document.getElementById('search-locations').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const locationItems = document.querySelectorAll('.location-item');

        locationItems.forEach(item => {
          const locationName = item.dataset.name;
          if (locationName.includes(searchTerm)) {
            item.style.display = 'block';
          } else {
            item.style.display = 'none';
          }
        });
      });

      // Location list item click handlers
      document.querySelectorAll('.location-item').forEach(function(item) {
        item.addEventListener('click', function() {
          const lat = parseFloat(this.dataset.lat);
          const lng = parseFloat(this.dataset.lng);

          // Fly to location
          map.setView([lat, lng], 12);

          // Find and open the corresponding marker popup
          allMarkers.forEach(marker => {
            const markerLatLng = marker.getLatLng();
            if (Math.abs(markerLatLng.lat - lat) < 0.0001 &&
              Math.abs(markerLatLng.lng - lng) < 0.0001) {
              marker.openPopup();
            }
          });
        });

        // Add hover effect
        item.style.cursor = 'pointer';
        item.addEventListener('mouseenter', function() {
          this.classList.add('has-background-light');
        });
        item.addEventListener('mouseleave', function() {
          this.classList.remove('has-background-light');
        });
      });

      // Dynamic loading based on map bounds (optional advanced feature)
      let boundsTimeout;
      map.on('moveend', function() {
        clearTimeout(boundsTimeout);
        boundsTimeout = setTimeout(() => {
          const bounds = map.getBounds();
          // Uncomment to enable dynamic loading
          // loadLocationsInBounds(bounds);
        }, 1000);
      });

      async function loadLocationsInBounds(bounds) {
        try {
          const params = new URLSearchParams({
            north: bounds.getNorth(),
            south: bounds.getSouth(),
            east: bounds.getEast(),
            west: bounds.getWest()
          });

          const response = await fetch(`{% url "locations:locations_within_bounds" %}?${params}`);
          const data = await response.json();

          // Update markers based on current view
          // Implementation depends on your needs

        } catch (error) {
          console.error('Error loading locations in bounds:', error);
        }
      }
    });
  </script>
{% endblock %}
