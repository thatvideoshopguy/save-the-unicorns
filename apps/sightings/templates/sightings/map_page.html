{% extends "base.html" %}
{% load wagtailcore_tags %}

{% block extra_css %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
{% endblock %}

{% block content %}
  <section class="hero is-primary is-medium">
    <div class="hero-body">
      <div class="container">
        <h1 class="title is-1">{{ page.title }}</h1>
        {% if page.intro %}
          <div class="subtitle is-4">
            {{ page.intro|richtext }}
          </div>
        {% endif %}
      </div>
    </div>
  </section>

  <section class="section">
    <div class="container">
      <div class="columns">
        <div class="column is-8">
          <div class="box">
            <div id="map" class="map-container"></div>
          </div>
        </div>

        <div class="column is-4">
          <div class="box">
            <h3 class="title is-4">Locations</h3>
            <div class="location-list">
              {% for location in locations %}
                <div class="location-item"
                     data-lat="{{ location.latitude }}"
                     data-lng="{{ location.longitude }}"
                     data-name="{{ location.name }}">
                  <h5 class="title is-6 mb-2">{{ location.name }}</h5>
                  {% if location.description %}
                    <p class="content is-small mb-2">{{ location.description }}</p>
                  {% endif %}
                  {% if location.address %}
                    <p class="content is-small has-text-grey mb-2">
                                            <span class="icon is-small">
                                                <i class="fas fa-map-marker-alt"></i>
                                            </span>
                      {{ location.address }}
                    </p>
                  {% endif %}
                  {% if location.website %}
                    <p class="content is-small">
                      <a href="{{ location.website }}"
                         target="_blank"
                         class="button is-small is-link is-outlined">
                                                <span class="icon is-small">
                                                    <i class="fas fa-external-link-alt"></i>
                                                </span>
                        <span>Visit Website</span>
                      </a>
                    </p>
                  {% endif %}
                  <hr class="my-4">
                </div>
              {% empty %}
                <p class="content">No locations found.</p>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
{% endblock %}

{% block extra_js %}
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin=""></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize map using GeoDjango map center
      const map = L.map('map').setView([{{ map_center_lat }}, {{ map_center_lng }}], {{ page.zoom_level }});

      // Add OpenStreetMap tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 18,
      }).addTo(map);

      // Custom icon
      const customIcon = L.divIcon({
        html: '<i class="fas fa-map-marker-alt has-text-danger"></i>',
        iconSize: [20, 20],
        className: 'custom-div-icon'
      });

      // Add markers for each location
      const locations = [
        {% for location in locations %}
          {
            name: "{{ location.name|escapejs }}",
            lat: {{ location.latitude }},
            lng: {{ location.longitude }},
            description: "{{ location.description|escapejs }}",
            address: "{{ location.address|escapejs }}",
            website: "{{ location.website|escapejs }}"
          }{% if not forloop.last %},{% endif %}
        {% endfor %}
      ];

      locations.forEach(function(location) {
        const marker = L.marker([location.lat, location.lng], {
          icon: customIcon
        }).addTo(map);

        let popupContent = `<div class="popup-content">
                    <h6 class="title is-6 mb-2">${location.name}</h6>`;

        if (location.description) {
          popupContent += `<p class="content is-small mb-2">${location.description}</p>`;
        }

        if (location.address) {
          popupContent += `<p class="content is-small has-text-grey mb-2">
                        <span class="icon is-small">
                            <i class="fas fa-map-marker-alt"></i>
                        </span>
                        ${location.address}
                    </p>`;
        }

        if (location.website) {
          popupContent += `<p class="content is-small">
                        <a href="${location.website}" target="_blank" class="button is-small is-link is-outlined">
                            <span class="icon is-small">
                                <i class="fas fa-external-link-alt"></i>
                            </span>
                            <span>Visit</span>
                        </a>
                    </p>`;
        }

        popupContent += `</div>`;

        marker.bindPopup(popupContent);
      });

      // Add click handlers to location list items
      document.querySelectorAll('.location-item').forEach(function(item) {
        item.addEventListener('click', function() {
          const lat = parseFloat(this.dataset.lat);
          const lng = parseFloat(this.dataset.lng);
          const name = this.dataset.name;

          // Fly to location
          map.setView([lat, lng], 12);

          // Find and open the corresponding marker popup
          map.eachLayer(function(layer) {
            if (layer instanceof L.Marker) {
              const markerLatLng = layer.getLatLng();
              if (Math.abs(markerLatLng.lat - lat) < 0.0001 &&
                Math.abs(markerLatLng.lng - lng) < 0.0001) {
                layer.openPopup();
              }
            }
          });
        });

        // Add hover effect
        item.style.cursor = 'pointer';
        item.addEventListener('mouseenter', function() {
          this.classList.add('has-background-light');
        });
        item.addEventListener('mouseleave', function() {
          this.classList.remove('has-background-light');
        });
      });
    });
  </script>
{% endblock %}
